//  names start with cap are states
//  names start with app:: are appliction handlers
//  names start with dum:: are dum interface to application
//  names start with lower case are actions
//  names start with on are events

digraph UAC {
  rankdir=LR;
  node [shape = box];

  // Should we use UPDATE to send offer or reINVITE? How does the app know which to use? UPDATE needs to get a response right away
  Connected -> SentUpdate                 [ label = "dum::provideOffer/send::UPDATE" ];
  Connected -> SentReinvite               [ label = "dum::provideOffer/send::INVITE" ]; // UPDATE not supported
  Connected -> ReceivedUpdate             [ label = "onUPDATE|INVITE-offer/app::onOffer" ];
  Connected -> ReceivedReinviteNoOffer    [ label = "onINVITE/app::onDialogModified" ];
  Connected -> Connected                  [ label = "on200I/resend::ACK" ]; 
  Connected -> Connected                  [ label = "onCANCEL/send::200C" ]; // is this right?
  Connected -> Terminated                 [ label = "dum::end/send::BYE" ];
  Connected -> Terminated                 [ label = "onBYE/send::200B" ];

  SentUpdate -> Connected                 [ label = "on200U/app::onAnswer" ];
  SentUpdate -> Connected                 [ label = "on4XXU/app::onOfferRejected" ];
  SentUpdate -> SentUpdate                [ label = "onUPDATE|onINVITE/send::491" ];
  SentUpdate -> SentUpdateGlare           [ label = "on491U/timer::491" ];  
  SentUpdate -> Terminated                [ label = "onGeneralFailure/app::onTerminated,send::BYE" ];
  SentUpdate -> Terminated                [ label = "dum::end/send::BYE" ];

  SentUpdateGlare -> SentUpdate           [ label = "onTimer491/resend::UPDATE" ]; 
  SentUpdateGlare -> ReceivedUpdate       [ label = "onUPDATE/app::onOfferRejected,app::onOffer" ];
  SentUpdateGlare -> ReceivedReinvite     [ label = "onINVITE/app::onOfferRejected,app::onOffer" ];
  SentUpdateGlare -> Terminated           [ label = "dum::end/send::BYE" ];

  SentReinvite -> Connected               [ label = "on200I/app::onAnswer,send::ACK" ];// need to store the ACK
  SentReinvite -> Connected               [ label = "on4XXI/app::onOfferRejected" ];
  SentReinvite -> SentReinvite            [ label = "onINVITE|onUPDATE/send::491" ];
  SentReinvite -> SentReinviteGlare       [ label = "on491I/timer::491" ]; 
  SentReinvite -> WaitingToTerminate      [ label = "dum::end" ];
  SentReinvite -> Terminated              [ label = "onGeneralFailure/app::onTerminated,send::BYE" ];

  SentReinviteGlare -> SentReinvite       [ label = "onTimer491/resend::INVITE" ]; 
  SentReinviteGlare -> ReceivedUpdate     [ label = "onUPDATE/app::onOfferRejected,app::onOffer" ];
  SentReinviteGlare -> ReceivedReinvite   [ label = "onINVITE/app::onOfferRejected,app::onOffer" ];
  SentReinviteGlare -> Terminated         [ label = "dum::end/send::BYE" ];


  // If we require the app to synchronously provide an answer to an UPDATE then the 
  // ReceivedUpdate state is not necessary. If we want the app to be able to respond 
  // async then this state is necessary and the app must respond in a timely manner
  ReceivedUpdate -> Connected             [ label = "dum::provideAnswer/send::200U" ];
  ReceivedUpdate -> Connected             [ label = "dum::reject/send::488U" ];
  ReceivedUpdate -> Terminated            [ label = "dum::end/send::488U,send::BYE" ];
  ReceivedUpdate -> ReceivedUpdate        [ label = "onINVITE|onUPDATE/send::500" ]; 

  ReceivedReinvite -> Answered            [ label = "dum::provideAnswer/send::200I,timer::200I,timer::NoACK" ];
  ReceivedReinvite -> Connected           [ label = "dum::reject/send::488U" ];
  ReceivedReinvite -> Terminated          [ label = "dum::end/send::488I,send::BYE" ];
  ReceivedReinvite -> ReceivedReinvite    [ label = "onINVITE|onUPDATE/send::500" ]; 

  Answered -> Answered                    [ label = "timer::2xx/resend::2xx" ];
  Answered -> WaitingToOffer              [ label = "dum::provideOffer/saveOffer" ];
  Answered -> Connected                   [ label = "onACK" ];
  Answered -> Terminated                  [ label = "timer::NoACK/send::BYE" ];

  WaitingToOffer -> Answered              [ label = "timer::2xx/resend::2xx" ];
  WaitingToOffer -> SentUpdate            [ label = "onACK/send::UPDATE-offer" ]; 
  WaitingToOffer -> SentReinvite          [ label = "onACK/send::INVITE-offer" ]; 
  WaitingToOffer -> Terminated            [ label = "timer::NoACK/send::BYE" ];

  ReceivedReinviteNoOffer -> Connected    [ label = "dum::provideOffer/send::200-offer" ];
  ReceivedReinviteNoOffer -> Connected    [ label = "dum::reject/send::488I" ];
  ReceivedReinviteNoOffer -> Terminated   [ label = "dum::end/send::488I,send::BYE" ];
  ReceivedReinviteNoOffer -> ReceivedReinviteNoOffer  [ label = "onINVITE|onUPDATE/send::500" ]; 

  WaitingToTerminate -> Terminated        [ label = "on200I/send::ACK,send::BYE" ];
  WaitingToTerminate -> Terminated        [ label = "onFailureI/send::BYE" ];

  Terminated -> Terminated                [ label = "onResponse/destroy" ];
  Terminated -> Terminated                [ label = "onRequest/send::481,destroy" ];
}
